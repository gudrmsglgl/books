# 프로그램이 실행되었지만, <br>뭐가 뭔지 하나도 모르겠다

목차 <br>
[Section2.2 스레드 간 공유되는 프로세스 리소스](#id-section1)<br>
- [2.2.1 스레드 전용 리소스](#id-section2)<br>
- [2.2.2 코드영역: 모든 함수를 스레드에 배치하여 실행할 수 있다](#id-section3)<br>
- [2.2.3 데이터영역: 모든 스레드가 데이터 영역의 변수에 접근할 수 있다](#id-section4)<br>
- [2.2.4 힙 영역: 포인터가 핵심이다](#id-section5)<br>
- [2.2.5 스택 영역: 공유 공간 내 전용 데이터](#id-section6)<br>



<div id='id-section1'/>

## section2 스레드 간 공유되는 프로세스 리소스

**🧐프로세스와 스레드의 차이점은 무엇인가요?**
> *'프로세스는 운영 체제가 리소스를 할당하는 기본 단위고, '* <br>
> *'스레드는 스케줄링(scheduling)의 기본 단위이며,'* <br>
> *'프로세스 리소스는 스레드 간에 공유된다'* <br>

라고 유창하게 '외우고' 있지만 정말 제대로 이해하고 있는것이 맞을까? <br>

- 스레드 간에 어떤 프로세스 리소스를 공유하고 있을까?
- 공유 리소스는 무엇을 의미하나요?
- 공유 리소스는 어던 방식으로 작동할까요?

위 질문들을 이해하지 못 한다면  <br>
다중 프로세스 프로그램을 작성하는 것은 매우 어렵습니다.



<br>
<div id='id-section2'/>

### 2.2.1 스레드 전용 리소스

상태 변화 관점에서 보면 **스레드는 사실 함수 실행**입니다. <br>
실행 흐름에 인위적으로 ✌🏻스레드✌🏻라는 이름을 붙인 것에 불과
<br>

스레드가 상태 변화 관점에서 함수를 실행하는 것이라면 <br>
함수 실행에는 어떤 종류의 정보가 존재할까요? <br>

함수의 실행 시간 정보는 스택 영역을 구성하는 ✌🏻스택 프레임✌🏻에 저장됨 <br>
- 함수의 반환값
- 다른 함수를 호출할 때 전달되는 매개변수
- 함수 내에서 사용되는 지역 변수와 레지스터 정보가 저장.

![스크린샷, 2025-03-22 오후 2 56 10](https://github.com/user-attachments/assets/9312f0f4-bef9-4e62-a268-a93a1f4920e4)

CPU는 하나의 진입 함수의 명령어를 실행하여 실행 흐름인 스레드를 형성 <br>
이 때 각 스레드는 자신만 사용할 수 있는 스택 영역을 가지므로 <br>
스레드가 여러 개 있을 때는 여러 스택 영역이 존재하게 됩니다. <br>
<br>

**💁🏻 스택에서 가지고 있는 고유 정보들**
- PC 레지스터(register)
- 스레드 스택 영역에서 스택 상단(stack top) 위치를 저장하는 스택 포인터(stack pointer)
- CPU가 기계 명령어를 실행할 때 내부 레지스터 값 

다른 스레드에서는 이런 레지스터 정보에 접근할 수 없음.
**📌우리는 이러한 정보를 스레드 상황 정보(thread context)라고 함**

스레드는 프로세스 주소 공간에서 스택 영역을 제외한 나머지 영역을 모두 공유!



<br>
<div id='id-section3'/>

### 2.2.2 코드영역: 모든 함수를 스레드에 배치하여 실행할 수 있다

프로세스의 주소 공간의 코드 영역
- 프로그래머가 작성한 코드
- 더 정확하게는 컴파일 후 생성된 실행 가능한 기계 명령어가 저장됨.

기계 명령어
- 실행 파일에 저장되어 있음
- 프로그램이 시작될 때 프로세스 주소 공간에 ✌🏻적재✌🏻

코드 영역
- 스레드 간에 공유되므로 어떤 함수든지 모두 스레드에 적재하여 실행할 수 있음 <br>
- 특정 함수를 특정 스레드에서만 실행되도록 하는 것은 불가능 <br>
- 모든 스레드가 공유하는 영역
- 읽기 전용(read-only) -> 실행되는 동안에는 어떤 스레드도 코드 영역 내용을 변경할 수 없음
- 스레드 안전 문제(thread safety issue) 발생하지 않음

<br>
<div id='id-section4'/>

### 2.2.3 데이터영역: 모든 스레드가 데이터 영역의 변수에 접근할 수 있다

데이터 영역
- 전역 변수가 저장되는 곳.
- 프로그램이 실행되는 동안 데이터 영역 내에 전역 변수의 인스턴스(instance)는 하나만 있기 때문에 모든 스레드는 이 전역 변수에 접근할 수 있습니다.

```c++
char c; // 전역 변수

void fun() {

}
```


<br>
<div id='id-section5'/>

### 2.2.4 힙 영역: 포인터가 핵심이다
c, c++ 에서 malloc 함수와 new 예약어로 요청하는 메모리가 이 영역에 할당.
<br>
물론 모든 스레드는 해당 변수 주소만 알고 있다면, 다시 말해 포인터(pointer)를 얻을 수 있다면 <br>
포인터가 가리키는 데이터에 접근할 수 있습니다.
따라서 힙 영역은 스레드 간 공유 리소스이기도 함.

![스크린샷, 2025-03-22 오후 3 33 05](https://github.com/user-attachments/assets/e437c1ba-75b2-435f-b7db-0c4b451cbdc1)


<br>
<div id='id-section6'/>

### 2.2.5 스택 영역: 공유 공간 내 전용 데이터

**👀 프로세스 관점**
서로 다른 프로세스의 주소 공간은 서로 격리되어 있으며, <br>
가상 메모리 시스템은 매우 특별한 경우를 제외하고 <br>
다른 프로세스의 주소 공간에 속한 데이터에 직접 접근하지 못하도록 보장.  <br>

**👀 스레드 관점**
서로 다른 스레드의 스택 영역 간에는 이런 보호를 위한 작동 방식이 존재하지 않음. <br>
따라서 하나의 스레드가 다른 스레드의 스택 프레임에서 포인터를 가져올 수 있다면 <br>
해당 스레드는 다른 스레드의 스택 영역을 직접 읽고 쓸 수 있음. <br>
즉 다른 스레드의 스택 영역에 속한 변수를 임의로 수정할 수 있음을 의미 <br>
<br>

어떤 면에서 프로그래머에게는 매우 편리하지만, 그와 동시에 해결이 매우 어려운 버그(bug)로 이어질 수 있음 <br>

```c++
void foo(int* p)
{
  *p = 2;
}

int main()
{
  int a = 1;
  thread t(foo, &a);

  t.join();

  return 0;
}
```

**코드로 설명하는 스레드의 스택 영역 변수 수정**

> 먼저 a= 1; 주 스레드(main thread)에서 스택 영역에 저장되는 지역 변수 정의 <br>
이 지역 변수 a는 주 스레드의 전용 데이터에 속함 <br>
이어서 또 다른 스레드가 생성되는데, 이때 주 스레드의 지역 변수인 a의 주소가 매개변수 형태로 <br>
새로 생성되는 스레드에 전달 <br>
이제 새 스레드의 진입 함수인 foo가 <br>
다른 스레드에서 실행되면서 매개변수를 통해 지역 변수 a의 포인터인 p를 얻게 됨 <br>
포인터 p가 가리키고 있는 대상 값을 2로 변경하면 새로 생성된 스레드가 주 스레드 전용인 데이터를 수정하는 결과를 얻음 <br>
<br>

스레드 여러 개가 하나의 프로세스에 속하는 경우에는 <br>
**📌하나의 스레드가 다른 스레드의 스택 영역이라고 하더라도 <br>
모두 데이터를 읽고 쓸 수 있음.**
